name: Build and publish Docker image

on:
  release:
    types: [published]

env:
  IMAGE_NAME: lgballtdiscordbot

jobs:
  mage:
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v2
      -
        name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.16
      -
        name: Run Mage
        uses: magefile/mage-action@v1
        env:
          REGISTRY_AUTH_TOKEN: ${{ secrets.GH_TOKEN }}
          VERSION: ${GITHUB_REF/refs\/tags\//}
        with:
          version: latest
          args: -v setBuildVersion "$VERSION" docker:build docker:login ghcr.io codemicro docker:publish "ghcr.io/${{ github.repository }}/%s:latest"
